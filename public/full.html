<!doctype html>
<html>

<head>
    <title>QUp - JIRA REPORT</title>
    <script src='/public/nprogress.js'></script>
    <link rel='stylesheet' href='/public/nprogress.css'/>
	<script src="/public/Chart.bundle.js"></script>
	<style type="text/css">/* Chart.js */
		@-webkit-keyframes chartjs-render-animation{from{opacity:0.99}to{opacity:1}}@keyframes chartjs-render-animation{from{opacity:0.99}to{opacity:1}}.chartjs-render-monitor{-webkit-animation:chartjs-render-animation 0.001s;animation:chartjs-render-animation 0.001s;}</style>
	<script src="/public/utils.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/lodash@4.17.11/lodash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.13.0/moment.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script> 
	<style>
	canvas {
		-moz-user-select: none;
		-webkit-user-select: none;
		-ms-user-select: none;
	}    
    .chart-container {
		width: 40%;
		margin-left: 40px;
		margin-right: 40px;
		margin-bottom: 40px;
	}
	.container {
		display: flex;
		flex-direction: row;
		flex-wrap: wrap;
		justify-content: center;
	}
	</style>
</head>

<body>
     
    <div style="width: 100%">
            Filter:
        <select id="selectjql">
            <option value=0>Updated within the last 1 week (Scrum, Kanban)</option>
            <option value=1>4.6.29 All</option>
            <option value=2>4.6.29 Server</option>
            <option value=3>4.6.29 Web</option>
            <option value=4>4.6.29 App</option>
            <option value=5>4.6.28 All</option>
            <option value=6>4.6.28 App</option>
            <option value=7>4.6.28 Web</option>
            <option value=8>4.6.28 Server</option>
        </select> 
        <button id="process">Process</button>
        
    </div>
    
    <div style="width: 100%">
		<canvas id="canvas2"></canvas>
    <div>
        <select id="selectDateLineChart">
            <option value='0'>All</option>
            <option value='3'>3 days</option>
            <option value='5'>5 days</option>
            <option value='7'>7 days</option>
        </select> 
        <button id="myreport2" hidden=true>My report</button>
        <a target="_blank" rel="noopener noreferrer" id="myworklog"></a>
    </div>

    <div>List logwork within last 3 days</div>
    <div style="width: 100%">
        <table id="tablealllogwork" style="width: 100%" border="1">
        </table>
    </div>
	<div style="width: 100%">
		<canvas id="canvas1"></canvas>
    </div>
    
    <div style="width: 100%">
		<canvas id="canvas3"></canvas>
    </div>
    <div class="container">
        <div class="chart-container"><canvas id="canvas4"></canvas></div>
        <div class="chart-container"><canvas id="canvas5"></canvas></div>
    </div>
    <div><button id="changeCircleSize">Semi/Full Circle</button></div>
    <br>
    <div><h3>List warning:</h3></div>
    <br>
    <div style="width: 100%" >
        <table id="noLogwork" style="width: 100%" border="1">
            <tr>
                <th>No.</th>
                <th>User</th>
                <th>Key</th>
                <th>Detail</th>
            </tr>            
        </table>
    </div>
	<script>
        // DEPRECATED       
        window.onload = function() {
            var ctx2 = document.getElementById('canvas2').getContext('2d');
            var ctx3 = document.getElementById('canvas3').getContext('2d'); 
            var ctx1 = document.getElementById('canvas1').getContext('2d'); 
            var ctx4 = document.getElementById('canvas4').getContext('2d'); 
            var ctx5 = document.getElementById('canvas5').getContext('2d'); 
            var color = Chart.helpers.color;
            var timeFormat = 'MM/DD/YYYY HH:mm';
            var session = {};
            var myreport2 = false;
            var all_data = {};
            var config1 = {
                type: 'bar',
                data: {},
                options: {	
                    title: {
                        display: true,
                        text: 'LOGWORK - SPENT TIME / ESTIMATE'
                    },
                    tooltips: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            // Use the footer callback to display the sum of the items showing in the tooltip
                            footer: function(tooltipItems, data) {
                                var sum = 0;
                                var len = tooltipItems.length;
                                tooltipItems.forEach(function(tooltipItem) {       
                                    if (tooltipItem.datasetIndex != len-1) {
                                        sum += data.datasets[tooltipItem.datasetIndex].data[tooltipItem.index];
                                    }                             
                                });
                                return 'Logwork Sum: ' + sum;
                            }
                        },
                        footerFontStyle: 'normal'
                    },
                    responsive: true,
                    scales: {
                        xAxes: [{
                            stacked: true,
                            scaleLabel: {
                                display: true,
                                labelString: 'Members'
                            }
                        }],
                        yAxes: [{
                            stacked: true,
                            scaleLabel: {
                                display: true,
                                labelString: 'Hours'
                            }
                        }]
                    },
                    
                }
            };
            var config2 = {
                type: 'line',
                data: {},
                options: {
                    title: {
                        display: true,
                        text: 'LOGWORK ACTIVITIES'
                    },
                    zoomEnabled: true,
                    tooltips: {
                        mode: 'index',
                        callbacks: {
                            // Use the footer callback to display the sum of the items showing in the tooltip
                            footer: function(tooltipItems, data) {
                                var sum = 0;

                                tooltipItems.forEach(function(tooltipItem) {
                                    sum += data.datasets[tooltipItem.datasetIndex].data[tooltipItem.index].y;
                                });
                                return 'Sum: ' + sum;
                            },
                        },
                        footerFontStyle: 'normal'
                    },
                    scales: {
                        xAxes: [{
                            type: 'time',
                            time: {
                                format: timeFormat,
                                // round: 'day'
                                tooltipFormat: 'll HH:mm'
                            },
                            scaleLabel: {
                                display: true,
                                labelString: 'Date'
                            }
                        }],
                        yAxes: [{
                            scaleLabel: {
                                display: true,
                                labelString: 'Hours'
                            }
                        }]
                    },
                }
            };
            var config3 = {
                type: 'bar',
                data: {},
                options: {	
                    title: {
                        display: true,
                        text: 'TOTAL ISSUES BY COMPONENTS - STATUS'
                    },
                    tooltips: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            // Use the footer callback to display the sum of the items showing in the tooltip
                            footer: function(tooltipItems, data) {
                                var sum = 0;

                                tooltipItems.forEach(function(tooltipItem) {
                                    sum += data.datasets[tooltipItem.datasetIndex].data[tooltipItem.index];
                                });
                                return 'Sum: ' + sum;
                            }
                        },
                        footerFontStyle: 'normal'
                    },
                    responsive: true,
                    scales: {
                        xAxes: [{
                            stacked: true,
                            scaleLabel: {
                                display: true,
                                labelString: 'Components'
                            }
                        }],
                        yAxes: [{
                            stacked: true,
                            scaleLabel: {
                                display: true,
                                labelString: 'Hours'
                            }
                        }]
                    },
                    
                }
            }
            var config4 = {
                type: 'doughnut',
                data: {},
                options: {
                    responsive: true,
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: 'Issue status'
                    },
                    animation: {
                        animateScale: true,
                        animateRotate: true
                    }
                }
            };
            var config5 = {
                type: 'doughnut',
                data: {},
                options: {
                    responsive: true,
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: 'Issue types'
                    },
                    animation: {
                        animateScale: true,
                        animateRotate: true
                    }
                }
            };
            var chart1 = new Chart(ctx1, config1);    
            var chart2 = new Chart(ctx2, config2);    
            var chart3 = new Chart(ctx3, config3);
            var chart4 = new Chart(ctx4, config4);
            var chart5 = new Chart(ctx5, config5);
            var canvas2 = document.getElementById("canvas2");
            canvas2.onclick = function(evt) {
                var activePoints  = chart2.getElementsAtEvent(evt)[0];
                if (activePoints ) {    
                    console.log(activePoints);
                }
            }
            function generateLineChartLogWork(allUsers, dates, days){
                var lineChartData = {
                    labels: [],
                    datasets: []
                };
                var now = new moment().hour(0).minute(0).second(0).millisecond(0);
                _.map(_.keys(dates).sort(), function(time){
                    var duration = moment.duration(now.diff(moment(time, "YYYY-MM-DD"))).asDays();
                    if (duration <= days && days) {
                        lineChartData.labels.push(moment(time).toDate());
                    } else if (!days){
                        lineChartData.labels.push(moment(time).toDate());
                    }
                })
                let users = _.keys(allUsers);
                _.map(users, function(user){
                    var dataset = {
                        label: user,
                        backgroundColor: window.jira_color.users[user] || 'rbg(0,0,0)',
                        borderColor: window.jira_color.users[user] || 'rbg(0,0,0)',
                        fill: false,
                        data: []
                    };        
                    _.map(_.keys(dates).sort(), function(time){
                        var duration = moment.duration(now.diff(moment(time, "YYYY-MM-DD"))).asDays();
                        if (duration <= days && days) {
                            if (dates[time][user]){
                                dataset.data.push({
                                    x: moment(time).format(timeFormat),
                                    y: dates[time][user].total/60/60
                                })
                            } else {
                                dataset.data.push({
                                    x: moment(time).format(timeFormat),
                                    y: 0
                                })
                            } 
                        } else if (!days){
                            if (dates[time][user]){
                                dataset.data.push({
                                    x: moment(time).format(timeFormat),
                                    y: dates[time][user].total/60/60
                                })
                            } else {
                                dataset.data.push({
                                    x: moment(time).format(timeFormat),
                                    y: 0
                                })
                            }
                        }                        
                    })
                    lineChartData.datasets.push(dataset);
                }) 
                return lineChartData;
            }
            $('#selectDateLineChart').on('change', function() {
                var days = parseInt(this.value);
                console.log(days);
                chart2.data = generateLineChartLogWork(all_data.users, all_data.dates, days);
                chart2.update(); 
            });
            document.getElementById('myreport2').addEventListener('click', function() {
                for(var i in chart2.config.data.datasets){
                    if(chart2.config.data.datasets[i].label !== session.name){
                        chart2.getDatasetMeta(i).hidden= myreport2 ? null : true ;
                    } else {
                        chart2.getDatasetMeta(i).hidden= null;
                    }                    
                }
                myreport2 = !myreport2;
                chart2.update(); 
            })
            document.getElementById('changeCircleSize').addEventListener('click', function() {
                if (chart4.options.circumference === Math.PI) {
                    chart4.options.circumference = 2 * Math.PI;
                    chart4.options.rotation = -Math.PI / 2;
                } else {
                    chart4.options.circumference = Math.PI;
                    chart4.options.rotation = -Math.PI;
                }
                if (chart5.options.circumference === Math.PI) {
                    chart5.options.circumference = 2 * Math.PI;
                    chart5.options.rotation = -Math.PI / 2;
                } else {
                    chart5.options.circumference = Math.PI;
                    chart5.options.rotation = -Math.PI;
                }

                chart4.update();
                chart5.update();
            });
            document.getElementById('process').addEventListener('click', function() {
                document.getElementById('myreport2').hidden = true;
                NProgress.start();
                $.each($("#selectjql option:selected"), function(){
                    var jql = $(this).val();
                    $.post('/jql', {jql: jql}, function (record) {
                        console.log(record);
                        all_data = record;
                        session = record.session;
                        document.getElementById('myreport2').innerText = record.session.name;
                        document.getElementById('myreport2').hidden = false;
                        var keys = '';   
                        record.mydata.logwork.forEach(function(wl){
                            keys += ',' + wl.key;
                        })
                        keys = keys.substr(1);
                        document.getElementById('myworklog').setAttribute("href", record.jiraDomain + "/issues/?jql=key in ("+keys+") ORDER BY updated DESC");
                        document.getElementById('myworklog').innerText = "My logwork: " + record.jiraDomain + "/issues/?jql=key in ("+keys+")";
                        chart1.data = record.barChartLogworkData;
                        chart1.update();  
                        chart3.data = record.barChartComponentData;
                        chart3.update();
                        ///
                        $.each($("#selectDateLineChart option:selected"), function(){
                            var days = parseInt($(this).val());
                            var lineChartData = generateLineChartLogWork(record.users, record.dates, days);
                            chart2.data = lineChartData;
                            chart2.update(); 
                        })
                        

                        chart4.data = record.doughnutChartStatusData;
                        chart4.update();
                        chart5.data = record.doughnutChartTypesData;
                        chart5.update();
                        var tableNologwork = document.getElementById("noLogwork");
                        var tableAlllogwork = document.getElementById("tablealllogwork");
                        $("#noLogwork tr").remove(); 
                        $("#tablealllogwork tr").remove(); 

                        record.mydata.logwork.forEach(function(wl){
                            keys += ',' + wl.key;
                        })
                        for (var i in record.logwork) {
                            var row = tableAlllogwork.insertRow(0);
                            var cell1 = row.insertCell(0);
                            var cell2 = row.insertCell(1);
                            var cell3 = row.insertCell(2);
                            var cell4 = row.insertCell(3);
                            var cell5 = row.insertCell(4);
                            cell1.innerHTML = record.logwork[i].name;
                            cell2.innerHTML = '<img src="'+record.logwork[i].issuesTypeIconUrl+'"></img> <a target="_blank" rel="noopener noreferrer" href="'+record.logwork[i].issueLink+'">'+record.logwork[i].key+' - ' + _.truncate(record.logwork[i].summary, {"length": 100, "omission": "..."}) + '</a>';
                            cell3.innerHTML = record.logwork[i].time;
                            cell4.innerHTML = record.logwork[i].timespent;
                            cell5.innerHTML = record.logwork[i].status;
                        }
                        for (var i in record.fouls){
                            var row = tableNologwork.insertRow(0);
                            var cell1 = row.insertCell(0);
                            var cell2 = row.insertCell(1);
                            var cell3 = row.insertCell(2);
                            var cell4 = row.insertCell(3);
                            cell1.innerHTML = parseInt(i) + 1;
                            cell2.innerHTML = '<img src="'+record.fouls[i].avatar+'"></img>' + record.fouls[i].user;
                            cell3.innerHTML = '<img src="'+record.fouls[i].issuesTypeIconUrl+'"></img> <a target="_blank" rel="noopener noreferrer" href="'+record.fouls[i].issueLink+'">'+record.fouls[i].key+' - ' + _.truncate(record.fouls[i].summary, {"length": 100, "omission": "..."}) + '</a>';
                            cell4.innerHTML = record.fouls[i].msg;
                        }
                    
                        NProgress.done();          
                    })               
                });
            }); 
		};
        
		
	</script>
</body>

</html>
