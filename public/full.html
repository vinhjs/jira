<!doctype html>
<html>

<head>
    <title>QUp - JIRA REPORT</title>
    <script src='/public/nprogress.js'></script>
    <link rel='stylesheet' href='/public/nprogress.css'/>
	<script src="/public/Chart.bundle.js"></script>
	<style type="text/css">/* Chart.js */
		@-webkit-keyframes chartjs-render-animation{from{opacity:0.99}to{opacity:1}}@keyframes chartjs-render-animation{from{opacity:0.99}to{opacity:1}}.chartjs-render-monitor{-webkit-animation:chartjs-render-animation 0.001s;animation:chartjs-render-animation 0.001s;}</style>
	<script src="/public/utils.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/lodash@4.17.11/lodash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.13.0/moment.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script> 
	<style>
	canvas {
		-moz-user-select: none;
		-webkit-user-select: none;
		-ms-user-select: none;
	}
	</style>
</head>

<body>
     
    <div style="width: 100%">
            Filter:
        <select id="selectjql">
            <option value=0>Updated within the last 1 week (Scrum, Kanban)</option>
            <option value=1>4.6.29 All</option>
            <option value=2>4.6.29 Server</option>
            <option value=3>4.6.29 Web</option>
            <option value=4>4.6.29 App</option>
            <option value=5>4.6.28 All</option>
            <option value=6>4.6.28 App</option>
            <option value=7>4.6.28 Web</option>
            <option value=8>4.6.28 Server</option>
        </select> 
        <button id="process">Process</button>
        
    </div>
    
    <div style="width: 100%">
		<canvas id="canvas2"></canvas>
    <div><button id="myreport2" hidden=true>My report</button><a target="_blank" rel="noopener noreferrer" id="myworklog"></a></div>

    <div>List logwork within last 3 days</div>
    <div style="width: 100%">
        <table id="tablealllogwork" style="width: 100%" border="1">
        </table>
    </div>
	<div style="width: 100%">
		<canvas id="canvas1"></canvas>
    </div>
    
    <div style="width: 100%">
		<canvas id="canvas3"></canvas>
    </div>
    <div style="width: 100%">
        <table id="noLogwork" style="width: 100%" border="1">
            <tr>
                <th>No.</th>
                <th>User</th>
                <th>Key</th>
                <th>Detail</th>
            </tr>            
        </table>
    </div>
	<script>
        // DEPRECATED       
        window.onload = function() {
            var ctx2 = document.getElementById('canvas2').getContext('2d');
            var ctx3 = document.getElementById('canvas3').getContext('2d'); 
            var ctx1 = document.getElementById('canvas1').getContext('2d'); 
            var color = Chart.helpers.color;
            var timeFormat = 'MM/DD/YYYY HH:mm';
            var session = {};
            var myreport2 = false;
            var config1 = {
                type: 'bar',
                data: {},
                options: {	
                    title: {
                        display: true,
                        text: 'LOGWORK - SPENT TIME'
                    },
                    tooltips: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            // Use the footer callback to display the sum of the items showing in the tooltip
                            footer: function(tooltipItems, data) {
                                var sum = 0;

                                tooltipItems.forEach(function(tooltipItem) {
                                    sum += data.datasets[tooltipItem.datasetIndex].data[tooltipItem.index];
                                });
                                return 'Sum: ' + sum;
                            }
                        },
                        footerFontStyle: 'normal'
                    },
                    responsive: true,
                    scales: {
                        xAxes: [{
                            stacked: true,
                            scaleLabel: {
                                display: true,
                                labelString: 'Members'
                            }
                        }],
                        yAxes: [{
                            stacked: true,
                            scaleLabel: {
                                display: true,
                                labelString: 'Hours'
                            }
                        }]
                    },
                    
                }
            };
            var config2 = {
                type: 'line',
                data: {},
                options: {
                    title: {
                        display: true,
                        text: 'LOGWORK ACTIVITIES'
                    },
                    zoomEnabled: true,
                    tooltips: {
                        mode: 'index',
                        callbacks: {
                            // Use the footer callback to display the sum of the items showing in the tooltip
                            footer: function(tooltipItems, data) {
                                var sum = 0;

                                tooltipItems.forEach(function(tooltipItem) {
                                    sum += data.datasets[tooltipItem.datasetIndex].data[tooltipItem.index].y;
                                });
                                return 'Sum: ' + sum;
                            },
                        },
                        footerFontStyle: 'normal'
                    },
                    scales: {
                        xAxes: [{
                            type: 'time',
                            time: {
                                format: timeFormat,
                                // round: 'day'
                                tooltipFormat: 'll HH:mm'
                            },
                            scaleLabel: {
                                display: true,
                                labelString: 'Date'
                            }
                        }],
                        yAxes: [{
                            scaleLabel: {
                                display: true,
                                labelString: 'hours'
                            }
                        }]
                    },
                }
            };
            var config3 = {
                type: 'bar',
                data: {},
                options: {	
                    title: {
                        display: true,
                        text: 'COMPONENTS - STATUS'
                    },
                    tooltips: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            // Use the footer callback to display the sum of the items showing in the tooltip
                            footer: function(tooltipItems, data) {
                                var sum = 0;

                                tooltipItems.forEach(function(tooltipItem) {
                                    sum += data.datasets[tooltipItem.datasetIndex].data[tooltipItem.index];
                                });
                                return 'Sum: ' + sum;
                            }
                        },
                        footerFontStyle: 'normal'
                    },
                    responsive: true,
                    scales: {
                        xAxes: [{
                            stacked: true,
                            scaleLabel: {
                                display: true,
                                labelString: 'Components'
                            }
                        }],
                        yAxes: [{
                            stacked: true,
                            scaleLabel: {
                                display: true,
                                labelString: 'Hours'
                            }
                        }]
                    },
                    
                }
            }
            var chart1 = new Chart(ctx1, config1);    
            var chart2 = new Chart(ctx2, config2);    
            var chart3 = new Chart(ctx3, config3);
            document.getElementById('myreport2').addEventListener('click', function() {
                for(var i in chart2.config.data.datasets){
                    if(chart2.config.data.datasets[i].label !== session.name){
                        chart2.getDatasetMeta(i).hidden= myreport2 ? null : true ;
                    } else {
                        chart2.getDatasetMeta(i).hidden= null;
                    }                    
                }
                myreport2 = !myreport2;
                chart2.update(); 
            })
            document.getElementById('process').addEventListener('click', function() {
                document.getElementById('myreport2').hidden = true;
                NProgress.start();
                $.each($("#selectjql option:selected"), function(){
                    var jql = $(this).val();
                    $.post('/jql', {jql: jql}, function (record) {
                        console.log(record);
                        session = record.session;
                        document.getElementById('myreport2').innerText = record.session.name;
                        document.getElementById('myreport2').hidden = false;
                        var keys = '';   
                        record.mydata.logwork.forEach(function(wl){
                            keys += ',' + wl.key;
                        })
                        keys = keys.substr(1);
                        document.getElementById('myworklog').setAttribute("href", record.jiraDomain + "/issues/?jql=key in ("+keys+") ORDER BY updated DESC");
                        document.getElementById('myworklog').innerText = "My logwork: " + record.jiraDomain + "/issues/?jql=key in ("+keys+")";
                        chart1.data = record.barChartLogworkData;
                        chart1.update();  
                        chart3.data = record.barChartComponentData;
                        chart3.update();
                        ///
                        
                        var lineChartData = {
                            labels: [],
                            datasets: []
                        };
                        _.map(_.keys(record.dates).sort(), function(time){
                            lineChartData.labels.push(moment(time).toDate());        
                        })
                        let users = _.keys(record.users);
                        _.map(users, function(user){
                            var dataset = {
                                label: user,
                                backgroundColor: window.jira_color.users[user] || 'rbg(0,0,0)',
                                borderColor: window.jira_color.users[user] || 'rbg(0,0,0)',
                                fill: false,
                                data: []
                            };        
                            _.map(_.keys(record.dates).sort(), function(time){
                                if (record.dates[time][user]){
                                    dataset.data.push({
                                        x: moment(time).format(timeFormat),
                                        y: record.dates[time][user].total/60/60
                                    })
                                } else {
                                    dataset.data.push({
                                        x: moment(time).format(timeFormat),
                                        y: 0
                                    })
                                }       
                            })
                            lineChartData.datasets.push(dataset);
                        })              
                        chart2.data = lineChartData;
                        chart2.update(); 

                        var tableNologwork = document.getElementById("noLogwork");
                        var tableAlllogwork = document.getElementById("tablealllogwork");
                        record.mydata.logwork.forEach(function(wl){
                            keys += ',' + wl.key;
                        })
                        for (var i in record.logwork) {
                            var row = tableAlllogwork.insertRow(0);
                            var cell1 = row.insertCell(0);
                            var cell2 = row.insertCell(1);
                            var cell3 = row.insertCell(2);
                            var cell4 = row.insertCell(3);
                            cell1.innerHTML = record.logwork[i].name;
                            cell2.innerHTML = '<a target="_blank" rel="noopener noreferrer" href="'+record.logwork[i].issueLink+'">'+record.logwork[i].key+' - ' + _.truncate(record.logwork[i].summary, {"length": 100, "omission": "..."}) + '</a>';
                            cell3.innerHTML = record.logwork[i].time;
                            cell4.innerHTML = record.logwork[i].timespent;
                        }
                        for (var i in record.fouls){
                            var row = tableNologwork.insertRow(0);
                            var cell1 = row.insertCell(0);
                            var cell2 = row.insertCell(1);
                            var cell3 = row.insertCell(2);
                            var cell4 = row.insertCell(3);
                            cell1.innerHTML = parseInt(i) + 1;
                            cell2.innerHTML = '<img src="'+record.fouls[i].avatar+'"></img>' + record.fouls[i].user;
                            cell3.innerHTML = '<a target="_blank" rel="noopener noreferrer" href="'+record.fouls[i].issueLink+'">'+record.fouls[i].key+' - ' + _.truncate(record.fouls[i].summary, {"length": 100, "omission": "..."}) + '</a>';
                            cell4.innerHTML = record.fouls[i].msg;
                        }
                    
                        NProgress.done();          
                    })               
                });
            }); 
		};
        
		
	</script>
</body>

</html>
